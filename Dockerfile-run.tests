# This Dockerfile is for compiling TauDEM for Linux and running the tests. It is not intended for running TauDEM.

# --- Builder Stage ---
FROM ubuntu:22.04 AS builder

LABEL maintainer="TauDEM Developers"
LABEL description="Builder stage for TauDEM test image"

ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    libopenmpi-dev \
    libgdal-dev \
    libproj-dev \
    libtiff-dev \
    libgeotiff-dev \
    git \
    ca-certificates \
    sudo \
    nano \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src

# Copy only source code and essential files (use .dockerignore to exclude build, test_data, etc.)
COPY . .

# Build TauDEM and install to /install/taudem
RUN make clean && \
    make release COMPILER=linux && \
    make install PREFIX=/install && \
    test -f /install/taudem/pitremove || (echo "ERROR: pitremove not found" && exit 1)

# --- Test Stage ---
FROM ubuntu:22.04 AS test

LABEL maintainer="TauDEM Developers"
LABEL description="Test stage for TauDEM with bats and test data"

ENV DEBIAN_FRONTEND=noninteractive

# Install only runtime and test dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    openmpi-bin \
    libgdal30 \
    git \
    ca-certificates \
    build-essential \
    cmake \
    sudo \
    nano \
    && rm -rf /var/lib/apt/lists/*

# Install bats testing framework and extensions
RUN git clone https://github.com/sstephenson/bats.git /tmp/bats && \
    /tmp/bats/install.sh /usr/local && \
    git clone https://github.com/ztombol/bats-support /tmp/bats-support && \
    git clone https://github.com/ztombol/bats-assert /tmp/bats-assert && \
    git clone https://github.com/ztombol/bats-file /tmp/bats-file && \
    rm -rf /tmp/bats

# Copy TauDEM binaries from builder
COPY --from=builder /install/taudem /usr/local/taudem

# Create non-root user for running tests
RUN useradd -m -s /bin/bash taudem-docker && \
    echo "taudem-docker:taudem-docker" | chpasswd && \
    usermod -aG sudo taudem-docker && \
    echo 'export PATH="/usr/local/taudem:${PATH}"' >> /home/taudem-docker/.bashrc && \
    echo 'export TAUDEM_PATH="/usr/local/taudem"' >> /home/taudem-docker/.bashrc

# Set up test data directory and permissions
WORKDIR /home/taudem-docker/workspace
RUN chown taudem-docker:taudem-docker /home/taudem-docker/workspace

# Clone TauDEM-Test-Data as non-root user
USER taudem-docker
RUN mkdir -p /home/taudem-docker/workspace/TauDEM-Test-Data
RUN git clone https://github.com/dtarb/TauDEM-Test-Data.git /home/taudem-docker/workspace/TauDEM-Test-Data && \
    chmod +x /home/taudem-docker/workspace/TauDEM-Test-Data/Input/taudem-tests.sh

WORKDIR /app

# Default to interactive shell
CMD ["/bin/bash"]